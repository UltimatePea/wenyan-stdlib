# æ–‡è¨€æ¨™æº–åº«æŒçºŒé›†æˆæµæ°´ç·š
# Wenyan Standard Library Continuous Integration Pipeline
# Author: Whisky, PR Worker

name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop, 'feature/*', 'infrastructure/*' ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # æ¯æ—¥å®šæ™‚æ§‹å»º Daily scheduled build at 02:00 UTC
    - cron: '0 2 * * *'

env:
  NODE_VERSION: '18'
  WENYAN_VERSION: 'latest'

jobs:
  # ä»£ç¢¼è³ªé‡æª¢æŸ¥ Code Quality Checks
  code-quality:
    name: ä»£ç¢¼è³ªé‡æª¢æŸ¥ Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: æª¢å‡ºä»£ç¢¼ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: è¨­ç½® Node.js Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: å®‰è£æ–‡è¨€ç·¨è­¯å™¨ Install Wenyan Compiler
      run: |
        npm install -g @wenyan/cli
        wenyan --version
    
    - name: èªžæ³•æª¢æŸ¥ Syntax Validation
      run: |
        echo "ðŸ” åŸ·è¡Œèªžæ³•æª¢æŸ¥ Running syntax validation..."
        find . -name "*.wy" -type f | while read -r file; do
          echo "æª¢æŸ¥æ–‡ä»¶ Checking: $file"
          if wenyan --check "$file"; then
            echo "âœ… $file èªžæ³•æ­£ç¢º"
          else
            echo "âŒ $file èªžæ³•éŒ¯èª¤"
            exit 1
          fi
        done
    
    - name: ç·¨ç¢¼æ¨™æº–æª¢æŸ¥ Coding Standards Check
      run: |
        echo "ðŸ“‹ åŸ·è¡Œç·¨ç¢¼æ¨™æº–æª¢æŸ¥ Running coding standards check..."
        
        # æª¢æŸ¥æ–‡ä»¶é ­éƒ¨è¨»é‡‹
        failed_files=0
        find . -name "*.wy" -type f | while read -r file; do
          if ! head -10 "$file" | grep -q "Author:"; then
            echo "âš ï¸  $file ç¼ºå°‘ä½œè€…ä¿¡æ¯"
            ((failed_files++))
          fi
        done
        
        if [ $failed_files -gt 0 ]; then
          echo "âŒ ç™¼ç¾ $failed_files å€‹ç·¨ç¢¼æ¨™æº–å•é¡Œ"
          exit 1
        else
          echo "âœ… ç·¨ç¢¼æ¨™æº–æª¢æŸ¥é€šéŽ"
        fi
    
    - name: æ–‡æª”æª¢æŸ¥ Documentation Check
      run: |
        echo "ðŸ“– æª¢æŸ¥æ–‡æª”å®Œæ•´æ€§ Checking documentation completeness..."
        
        # æª¢æŸ¥READMEæ–‡ä»¶
        if [ ! -f "README.md" ]; then
          echo "âŒ ç¼ºå°‘ README.md æ–‡ä»¶"
          exit 1
        fi
        
        # æª¢æŸ¥ç·¨ç¢¼æ¨™æº–æ–‡æª”
        if [ ! -f "æ–‡è¨€ç·¨ç¢¼æ¨™æº–æŒ‡å—.md" ]; then
          echo "âŒ ç¼ºå°‘ç·¨ç¢¼æ¨™æº–æ–‡æª”"
          exit 1
        fi
        
        echo "âœ… æ–‡æª”æª¢æŸ¥é€šéŽ"
    
    - name: ä¸Šå‚³ä»£ç¢¼è³ªé‡å ±å‘Š Upload Quality Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: code-quality-report
        path: |
          **/*.log
          **/è³ªé‡å ±å‘Š*
        retention-days: 30

  # æ§‹å»ºæ¸¬è©¦ Build and Test
  build-test:
    name: æ§‹å»ºå’Œæ¸¬è©¦ Build and Test
    runs-on: ubuntu-latest
    needs: code-quality
    
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        node-version: ['16', '18', '20']
      fail-fast: false
    
    steps:
    - name: æª¢å‡ºä»£ç¢¼ Checkout Code
      uses: actions/checkout@v4
    
    - name: è¨­ç½® Node.js Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: å®‰è£ä¾è³´ Install Dependencies
      run: |
        npm install -g @wenyan/cli
        
        # å®‰è£å…¶ä»–å¿…è¦å·¥å…· Install additional tools
        if [ "$RUNNER_OS" = "Linux" ]; then
          sudo apt-get update
          sudo apt-get install -y jq
        elif [ "$RUNNER_OS" = "macOS" ]; then
          brew install jq
        fi
      shell: bash
    
    - name: æ§‹å»ºç³»çµ±æª¢æŸ¥ Build System Check
      run: |
        chmod +x ./æ§‹å»ºç³»çµ±.sh
        chmod +x ./å¢žå¼·æ¸¬è©¦é‹è¡Œå™¨.sh
    
    - name: é‹è¡Œæ§‹å»ºç³»çµ± Run Build System
      run: |
        echo "ðŸ—ï¸ åŸ·è¡Œæ§‹å»ºç³»çµ± Running build system..."
        ./æ§‹å»ºç³»çµ±.sh --build-only
      env:
        CI: true
    
    - name: é‹è¡Œæ¸¬è©¦å¥—ä»¶ Run Test Suite
      run: |
        echo "ðŸ§ª åŸ·è¡Œæ¸¬è©¦å¥—ä»¶ Running test suite..."
        ./å¢žå¼·æ¸¬è©¦é‹è¡Œå™¨.sh
      env:
        CI: true
    
    - name: æ€§èƒ½åŸºæº–æ¸¬è©¦ Performance Benchmarks
      run: |
        echo "âš¡ åŸ·è¡Œæ€§èƒ½åŸºæº–æ¸¬è©¦ Running performance benchmarks..."
        # é‹è¡Œæ€§èƒ½æ¸¬è©¦ä¸¦ä¿å­˜çµæžœ
        mkdir -p performance-results
        ./å¢žå¼·æ¸¬è©¦é‹è¡Œå™¨.sh -t 500 > performance-results/benchmark-${{ matrix.os }}-node${{ matrix.node-version }}.log
    
    - name: ä¸Šå‚³æ§‹å»ºç”¢ç‰© Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts-${{ matrix.os }}-node${{ matrix.node-version }}
        path: |
          build/
          dist/
          docs/generated/
          test_results_*.log
          test_summary_*.html
          performance-results/
        retention-days: 30
    
    - name: ä¸Šå‚³æ¸¬è©¦å ±å‘Š Upload Test Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-reports-${{ matrix.os }}-node${{ matrix.node-version }}
        path: |
          test_results_*.log
          detailed_test_*.log
          test_summary_*.html
          test_results_*.json
        retention-days: 30

  # å®‰å…¨æŽƒæ Security Scanning
  security-scan:
    name: å®‰å…¨æŽƒæ Security Scan
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
    - name: æª¢å‡ºä»£ç¢¼ Checkout Code
      uses: actions/checkout@v4
    
    - name: ä»£ç¢¼å®‰å…¨æŽƒæ Code Security Scan
      run: |
        echo "ðŸ”’ åŸ·è¡Œå®‰å…¨æŽƒæ Running security scan..."
        
        # æª¢æŸ¥æ•æ„Ÿä¿¡æ¯æ´©éœ² Check for sensitive information leaks
        if grep -r "password\|secret\|key\|token" --include="*.wy" --include="*.md" --include="*.js" .; then
          echo "âš ï¸  ç™¼ç¾å¯èƒ½çš„æ•æ„Ÿä¿¡æ¯ Potential sensitive information found"
          # åœ¨å¯¦éš›ç’°å¢ƒä¸­é€™è£¡å¯èƒ½éœ€è¦æ›´åš´æ ¼çš„æª¢æŸ¥
        fi
        
        # æª¢æŸ¥æƒ¡æ„ä»£ç¢¼æ¨¡å¼ Check for malicious code patterns
        if grep -r "eval\|exec\|system\|shell_exec" --include="*.wy" --include="*.js" .; then
          echo "âš ï¸  ç™¼ç¾å¯èƒ½çš„å±éšªä»£ç¢¼ Potentially dangerous code found"
        fi
        
        echo "âœ… åŸºæœ¬å®‰å…¨æŽƒæå®Œæˆ Basic security scan completed"
    
    - name: ä¾è³´å®‰å…¨æª¢æŸ¥ Dependency Security Check
      run: |
        echo "ðŸ“¦ æª¢æŸ¥ä¾è³´å®‰å…¨æ€§ Checking dependency security..."
        # é€™è£¡å¯ä»¥æ·»åŠ æ›´å¤šçš„ä¾è³´å®‰å…¨æª¢æŸ¥
        echo "âœ… ä¾è³´å®‰å…¨æª¢æŸ¥å®Œæˆ Dependency security check completed"

  # æ€§èƒ½æ¸¬è©¦ Performance Testing
  performance-test:
    name: æ€§èƒ½æ¸¬è©¦ Performance Testing
    runs-on: ubuntu-latest
    needs: build-test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    
    steps:
    - name: æª¢å‡ºä»£ç¢¼ Checkout Code
      uses: actions/checkout@v4
    
    - name: è¨­ç½® Node.js Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
    
    - name: å®‰è£æ–‡è¨€ç·¨è­¯å™¨ Install Wenyan Compiler
      run: npm install -g @wenyan/cli
    
    - name: åŸ·è¡Œæ€§èƒ½æ¸¬è©¦ Run Performance Tests
      run: |
        echo "âš¡ åŸ·è¡Œè©³ç´°æ€§èƒ½æ¸¬è©¦ Running detailed performance tests..."
        chmod +x ./å¢žå¼·æ¸¬è©¦é‹è¡Œå™¨.sh
        ./å¢žå¼·æ¸¬è©¦é‹è¡Œå™¨.sh -t 100 -v
    
    - name: ç”Ÿæˆæ€§èƒ½å ±å‘Š Generate Performance Report
      run: |
        echo "ðŸ“Š ç”Ÿæˆæ€§èƒ½å ±å‘Š Generating performance report..."
        mkdir -p performance-reports
        
        # æ”¶é›†æ€§èƒ½æ•¸æ“šä¸¦ç”Ÿæˆå ±å‘Š
        cat > performance-reports/performance-summary.md << 'EOF'
        # æ€§èƒ½æ¸¬è©¦å ±å‘Š Performance Test Report
        
        **æ¸¬è©¦æ™‚é–“ Test Time**: $(date)
        **Gitæäº¤ Git Commit**: ${{ github.sha }}
        **åˆ†æ”¯ Branch**: ${{ github.ref_name }}
        
        ## æ¸¬è©¦ç’°å¢ƒ Test Environment
        - **æ“ä½œç³»çµ± OS**: Ubuntu Latest
        - **Node.jsç‰ˆæœ¬ Node.js Version**: ${{ env.NODE_VERSION }}
        - **Wenyanç‰ˆæœ¬ Wenyan Version**: Latest
        
        ## æ€§èƒ½åŸºæº– Performance Benchmarks
        <!-- å¯¦éš›æ€§èƒ½æ•¸æ“šå°‡åœ¨é€™è£¡æ’å…¥ -->
        
        EOF
    
    - name: ä¸Šå‚³æ€§èƒ½å ±å‘Š Upload Performance Report
      uses: actions/upload-artifact@v4
      with:
        name: performance-reports
        path: performance-reports/
        retention-days: 90

  # éƒ¨ç½²æ–‡æª” Deploy Documentation
  deploy-docs:
    name: éƒ¨ç½²æ–‡æª” Deploy Documentation
    runs-on: ubuntu-latest
    needs: [build-test, security-scan]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: æª¢å‡ºä»£ç¢¼ Checkout Code
      uses: actions/checkout@v4
    
    - name: è¨­ç½® Node.js Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
    
    - name: å®‰è£ä¾è³´ä¸¦ç”Ÿæˆæ–‡æª” Install Dependencies and Generate Docs
      run: |
        npm install -g @wenyan/cli
        sudo apt-get install -y jq
        chmod +x ./æ§‹å»ºç³»çµ±.sh
        ./æ§‹å»ºç³»çµ±.sh --docs-only
    
    - name: éƒ¨ç½²åˆ° GitHub Pages Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      if: github.ref == 'refs/heads/main'
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs/generated
        cname: wenyan-stdlib.github.io

  # ç™¼å¸ƒç‰ˆæœ¬ Release Version
  release:
    name: ç™¼å¸ƒç‰ˆæœ¬ Release Version
    runs-on: ubuntu-latest
    needs: [build-test, performance-test, security-scan]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && contains(github.event.head_commit.message, '[release]')
    
    steps:
    - name: æª¢å‡ºä»£ç¢¼ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: è¨­ç½® Node.js Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
    
    - name: å®‰è£ä¾è³´ Install Dependencies
      run: |
        npm install -g @wenyan/cli
        sudo apt-get install -y jq
    
    - name: ç”Ÿæˆç™¼å¸ƒç‰ˆæœ¬ Generate Release Build
      run: |
        chmod +x ./æ§‹å»ºç³»çµ±.sh
        ./æ§‹å»ºç³»çµ±.sh
    
    - name: å‰µå»ºç™¼å¸ƒæ¨™ç±¤ Create Release Tag
      id: tag_version
      run: |
        VERSION=$(date +"%Y.%m.%d-%H%M%S")
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        git tag "v$VERSION"
        git push origin "v$VERSION"
    
    - name: å‰µå»º GitHub ç™¼å¸ƒ Create GitHub Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ steps.tag_version.outputs.version }}
        release_name: æ–‡è¨€æ¨™æº–åº« v${{ steps.tag_version.outputs.version }}
        body: |
          ## æ–‡è¨€æ¨™æº–åº«ç™¼å¸ƒ Wenyan Standard Library Release
          
          **ç‰ˆæœ¬ Version**: ${{ steps.tag_version.outputs.version }}
          **ç™¼å¸ƒæ™‚é–“ Release Date**: $(date)
          **æäº¤ Commit**: ${{ github.sha }}
          
          ### æ›´æ–°å…§å®¹ Changes
          - è‡ªå‹•åŒ–ç™¼å¸ƒç‰ˆæœ¬ Automated release build
          - åŒ…å«æ‰€æœ‰åº«å’Œæ–‡æª” Includes all libraries and documentation
          - é€šéŽæ‰€æœ‰æ¸¬è©¦ Passes all tests
          
          ### ä½¿ç”¨æ–¹æ³• Usage
          ä¸‹è¼‰ç™¼å¸ƒåŒ…ä¸¦è§£å£“ï¼Œåƒè€ƒæ–‡æª”ä½¿ç”¨å„å€‹åº«
          Download the release package and extract, refer to documentation for usage
          
          ---
          **æ§‹å»ºè€… Built by**: GitHub Actions CI/CD Pipeline
        draft: false
        prerelease: false
    
    - name: ä¸Šå‚³ç™¼å¸ƒè³‡ç”¢ Upload Release Assets
      run: |
        # ä¸Šå‚³æ§‹å»ºç”¢ç‰©åˆ°ç™¼å¸ƒ
        find dist/ -name "*.tar.gz" -exec gh release upload v${{ steps.tag_version.outputs.version }} {} \;
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # é€šçŸ¥ç‹€æ…‹ Notification Status
  notify:
    name: é€šçŸ¥æ§‹å»ºç‹€æ…‹ Notify Build Status
    runs-on: ubuntu-latest
    needs: [code-quality, build-test, security-scan]
    if: always()
    
    steps:
    - name: æ§‹å»ºç‹€æ…‹é€šçŸ¥ Build Status Notification
      run: |
        if [ "${{ needs.code-quality.result }}" = "success" ] && \
           [ "${{ needs.build-test.result }}" = "success" ] && \
           [ "${{ needs.security-scan.result }}" = "success" ]; then
          echo "ðŸŽ‰ æ‰€æœ‰æª¢æŸ¥é€šéŽ All checks passed!"
          echo "âœ… ä»£ç¢¼è³ªé‡æª¢æŸ¥é€šéŽ Code quality checks passed"
          echo "âœ… æ§‹å»ºå’Œæ¸¬è©¦é€šéŽ Build and tests passed"
          echo "âœ… å®‰å…¨æŽƒæé€šéŽ Security scan passed"
        else
          echo "âŒ éƒ¨åˆ†æª¢æŸ¥å¤±æ•— Some checks failed!"
          echo "ä»£ç¢¼è³ªé‡ Code Quality: ${{ needs.code-quality.result }}"
          echo "æ§‹å»ºæ¸¬è©¦ Build Test: ${{ needs.build-test.result }}"
          echo "å®‰å…¨æŽƒæ Security Scan: ${{ needs.security-scan.result }}"
        fi
    
    - name: æ§‹å»ºæ‘˜è¦ Build Summary
      run: |
        echo "## ðŸ—ï¸ æ§‹å»ºæ‘˜è¦ Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **æäº¤ Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **åˆ†æ”¯ Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **è§¸ç™¼äº‹ä»¶ Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æ§‹å»ºæ™‚é–“ Build Time**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### æª¢æŸ¥çµæžœ Check Results" >> $GITHUB_STEP_SUMMARY
        echo "- ä»£ç¢¼è³ªé‡ Code Quality: ${{ needs.code-quality.result }} ${{ needs.code-quality.result == 'success' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
        echo "- æ§‹å»ºæ¸¬è©¦ Build Test: ${{ needs.build-test.result }} ${{ needs.build-test.result == 'success' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
        echo "- å®‰å…¨æŽƒæ Security Scan: ${{ needs.security-scan.result }} ${{ needs.security-scan.result == 'success' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY